 {% extends "views/layouts/pages/main.html" %}
{% block title %}<title>CMS | Add Collection</title>{% endblock %}
{% load static %}
{% block page-css %}
<link href="{%static 'assets/plugins/DataTables/media/css/dataTables.bootstrap.min.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/DataTables/extensions/Responsive/css/responsive.bootstrap.min.css' %}" rel="stylesheet" />
<!--  -->
<link href="{%static 'assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/ionRangeSlider/css/ion.rangeSlider.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/ionRangeSlider/css/ion.rangeSlider.skinNice.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/password-indicator/css/password-indicator.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-combobox/css/bootstrap-combobox.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-select/bootstrap-select.min.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/jquery-tag-it/css/jquery.tagit.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-daterangepicker/daterangepicker.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/select2/dist/css/select2.min.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-eonasdan-datetimepicker/build/css/bootstrap-datetimepicker.min.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/bootstrap-colorpalette/css/bootstrap-colorpalette.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/jquery-simplecolorpicker/jquery.simplecolorpicker.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/jquery-simplecolorpicker/jquery.simplecolorpicker-fontawesome.css' %}" rel="stylesheet" />
<link href="{%static 'assets/plugins/jquery-simplecolorpicker/jquery.simplecolorpicker-glyphicons.css' %}" rel="stylesheet" />
<style>
    .nameBox {
        background-color: white !important;
        color: black;
        font-weight: bold;
    }
    .disabledInput {
        background-color: #363636 !important;
        color: white !important;
        font-weight: bold !important;
    }
    #uacs_select {
        z-index: 9999;
    }
    div.dropdown-menu.open{
        max-height: 314px !important;
        overflow: hidden;
    }
    ul.dropdown-menu.inner{
        max-height: 260px !important;
        overflow-y: auto;
    }
</style>
<style type="text/css" media="print">
    .hidden-print {
        display: none; 
    }
</style>
{% endblock %}
{% block content %}
<!-- begin #content -->
<div id="content" class="content">
    <!-- begin breadcrumb -->
    <ol class="breadcrumb pull-right">
        <li class="breadcrumb-item"><a href="javascript:;">Collections</a></li>
        <li class="breadcrumb-item active"><a href="javascript:;">Add Collection</a></li>
    </ol>
    <!-- end breadcrumb -->
    <!-- begin page-header -->
    <h1 class="page-header">Add Collection</h1>
    <!-- end page-header -->
    <!-- begin card -->
    <div class="card text-left">
        <div class="card-header bg-inverse text-white">
            <i class="fas fa-calculator fa-lg m-r-5"></i>Add Collection
        </div>
        <div class="card-block">
            <!-- begin panel -->
            <div class="panel panel-white m-b-0" style="margin-top: -10px;">
                <div class="panel-body">
                    <form class="form-horizontal" id="addForm" action="#" method="POST" data-parsley-excluded="input[type=hidden], :hidden" autocomplete="off">
                        <!-- begin row -->
                        <div class="row" style="position: relative;">
                            <div class="col-lg-6">
                                <div class="form-group row m-b-15 m-t-15">
                                    <label class="col-form-label col-md-3">OR Number <span class="pull-right">:</span></label>
                                    <div class="col-md-9">
                                        <input type="text" class="form-control m-b-5 f-s-12 disabledInput" data-parsley-required="true" data-parsley-required-message="OR number is required" id="or_num" onfocus="this.blur();" tabindex="-1"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group row m-b-15 m-t-15">
                                    <label class="col-form-label col-md-3">Date <span class="pull-right">:</span></label>
                                    <div class="col-md-9">
                                        <input type="text" value="{% now 'M. d, Y' %}" class="form-control m-b-5 f-s-12 disabledInput" data-parsley-required="true" data-parsley-required-message="Date is required" id="or_date" onfocus="this.blur();" tabindex="-1" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- end row -->
                        <!-- begin row -->
                        <div class="row" style="position: relative;">
                            <!-- begin col-6 -->
                            <div class="col-lg-6">
                                <div class="form-group row m-b-10">
                                    <label class="col-md-3 col-form-label">Payor <span class="pull-right">:</span></label>
                                    <div class="col-md-9">
                                        <div class="radio radio-css radio-inline">
                                            <input type="radio" name="radio_css" id="radiorequired3" checked />
                                            <label for="radiorequired3">Student</label>
                                        </div>
                                        <div class="radio radio-css radio-inline">
                                            <input type="radio" name="radio_css" id="radiorequired" />
                                            <label for="radiorequired">Non-Student</label>
                                        </div>
                                        <div class="radio radio-css radio-inline">
                                            <input type="radio" name="radio_css" id="radiorequired2" />
                                            <label for="radiorequired2">Company</label>
                                        </div>   
                                    </div>
                                </div>
                                <div class="form-group row m-b-10">
                                    <label class="col-form-label col-md-3 m-b-10 studno">Student No. <span class="pull-right">:</span></label>
                                    <div class="col-md-9">
                                        <input type="text" id="or_studnum" class="form-control m-b-10 studno" required="true" data-parsley-required-message="Student number is required" placeholder="Student Number" autocomplete="off"/>
                                    </div>
                                    <label class="col-form-label col-md-3 m-b-10" style="display: none;">Educ Level <span class="pull-right">:</span></label>
                                    <div class="col-md-9" style="display: none;">
                                        <select class="form-control selectpicker individual_sel m-b-10" data-size="10" data-style="btn-white" id="educ-levels">
                                            <option selected disabled>Select level of education</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- end col-6 -->
                            <!-- begin col-6 -->
                            <div class="col-lg-6">
                                <div class="form-group row m-b-0">
                                    <label class="col-form-label col-md-3 m-b-10">Options <span class="pull-right">:</span></label>
                                    <div class="col-md-9">
                                        <div class="checkbox checkbox-css checkbox-inline">
                                            <input type="checkbox" id="direct_deposit_checkbox" value=""/>
                                            <label for="direct_deposit_checkbox">Direct Deposit</label>
                                        </div>  
                                        <div class="checkbox checkbox-css checkbox-inline" id="no-studnum-div">
                                            <input type="checkbox" id="no-studnum-checkbox" value=""/>
                                            <label for="no-studnum-checkbox">No Student Number</label>
                                        </div>                            
                                    </div>
                                </div>
                                <div class="individual">
                                    <div class="form-group row m-b-15">
                                        <label class="col-form-label col-md-3 m-b-10">Last Name <span class="pull-right">:</span></label>
                                        <div class="col-md-9">
                                            <input type="text" id="or_lname" style="text-transform: uppercase;" data-parsley-required="true" data-parsley-required-message="Lastname is required" class="form-control m-b-10 f-s-12 nameBox" autocomplete="off"/>
                                        </div>
                                        <label class="col-form-label col-md-3 m-b-10">First Name <span class="pull-right">:</span></label>
                                        <div class="col-md-9">
                                            <input type="text" id="or_fname" style="text-transform: uppercase;" data-parsley-required="true" data-parsley-required-message="Firstname is required" class="form-control m-b-10 f-s-12 nameBox" autocomplete="off"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="company" style="display: none; margin-bottom: 39px;">
                                    <div class="form-group row m-b-15">
                                        <label class="col-form-label col-md-3">Company Name <span class="pull-right">:</span></label>
                                        <div class="col-md-9">
                                            <input type="text" id="or_comp" style="text-transform: uppercase;" class="form-control m-b-5 f-s-12 nameBox" data-parsley-required="true" data-parsley-required-message="Company name is required"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- end col-6 -->
                        </div>
                        <!-- end row -->
                        <!-- begin hr -->
                        <hr class="bg-black-transparent-2 m-t-5 m-b-20">
                        <!-- end hr -->
                        <!-- begin row -->
                        <div class="row">
                            <!-- begin col-3 -->
                            <div class="col-lg-3">
                                <div class="form-group row m-b-15 m-t-15">
                                    <label class="col-md-5 col-sm-5 col-form-label">Income Type :</label>
                                    <div class="col-md-7 col-sm-7">
                                        <select class="form-control" data-dropup-auto="false" data-size="10" data-live-search="false" data-style="btn-white"  id="inc-select" data-parsley-excluded="true">
                                            <option value="Please choose" selected disabled>Please choose</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row m-b-15">
                                    <label class="col-md-5 col-sm-5 col-form-label">Description <span class="pull-right">:</span></label>
                                    <div class="col-md-7 col-sm-7">
                                        <select class="form-control" data-dropup-auto="false" data-size="10" data-live-search="true" data-style="btn-white" id="uacs_select" data-parsley-excluded="true">
                                            <option value="Please choose" selected disabled>Please choose</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row m-b-15" id="nature-div" style="display: none;">
                                    <label class="col-md-5 col-sm-5 col-form-label">Nature <span class="pull-right">:</span></label>
                                    <div class="col-md-7 col-sm-7">
                                        <select class="form-control" data-dropup-auto="false" data-size="10" data-live-search="true" data-style="btn-white" id="nature-select" data-parsley-excluded="true">
                                            <option value="Please choose" selected disabled>Please choose</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row m-b-15">
                                    <label class="col-md-5 col-sm-5 col-form-label" for="qty">Quantity <span class="pull-right">:</span></label>
                                    <div class="col-md-3 col-sm-3">
                                        <input class="form-control text-center" type="text" id="qty" name="qty" data-parsley-excluded="true" value="1" onfocus="this.blur()"/>
                                    </div>
                                    <div class="col-md-4 col-sm-4 text-nowrap m-t-5">
                                        <a href="javascript:;" class="btn btn-white btn-sm" id="qty-minus"><i class="fas fa-minus text-danger"></i></a>
                                        <a href="javascript:;" class="btn btn-white btn-sm" id="qty-plus"><i class="fas fa-plus text-success"></i></a>
                                    </div>
                                </div>
                                <div class="form-group row m-b-15">
                                    <label class="col-md-5 col-sm-5 col-form-label" for="number">Amount <span class="pull-right">:</span></label>
                                    <div class="col-md-7 col-sm-7">
                                        <input class="form-control" type="number" id="number" name="number" data-parsley-excluded="true" placeholder="Amount in peso"/>
                                    </div>
                                </div>
                                <div class="form-group row m-b-10">
                                    <label class="col-md-5 col-sm-5 col-form-label">&nbsp;</label>
                                    <div class="col-md-7 col-sm-7">
                                        <button type="button" class="btn btn-primary btn-sm" id="particular" disabled="true"><i class="fa fa-plus-circle m-r-5"></i>Add Particulars</button>
                                    </div>
                                </div>
                            </div>
                            <!-- end col-3 -->
                            <!-- begin col-9 -->
                            <div class="col-lg-9">
                                <div class="panel">
                                    <!-- begin panel-heading -->

                                    <!-- end panel-heading -->
                                    <!-- begin panel-body -->
                                    <div class="panel-body" style="border-radius: 5px;">
                                        <table id="data-table-responsives" class="table">
                                            <thead>
                                                <tr>
                                                    <th class="text-nowrap" width="20%">Income Type</th>
                                                    <th class="text-nowrap" width="30%">Description</th>
                                                    <th class="text-nowrap" width="20%">Nature</th>
                                                    <th class="text-nowrap" width="10%">Qty</th>
                                                    <th class="text-nowrap" width="15%">Amount</th>
                                                    <th class="text-nowrap" width="5%"></th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <!-- end panel-body -->
                                </div>
                                <table class="pull-left" style="margin-top: -20px;">
                                    <tr>
                                        <td  style="padding-left: 15px;"></td>
                                        <td><b>Total Amount : </b></td>
                                        <td class="f-s-14">
                                            ₱ <span id="total-fee" class="label label-warning f-s-12">0.00</span>
                                        </td>
                                    </tr>
                                </table>
                                <table class="pull-right">
                                    <td>
                                        <button type="button" id="save" class="btn btn-success" disabled><i class="fas fa-save m-r-5" id="save-icon"></i>Save Entry</button>
                                    </td>
                                </table>
                            </div>
                            <!-- end col-9 -->
                        </div>  
                        <!-- end row -->
                    </form>
                </div>
            </div>
            <!-- end panel -->
        <div class="card-footer text-grey-darker f-s-10">

        </div>
        </div>
    </div>
    <!-- end card -->
</div>
<!-- end #content -->
{% endblock %}
{% include "views/layouts/includes/base_js.html" %}
{% block page-js %} 
<script src="{%static 'assets/plugins/highlight/highlight.common.js' %}"></script>
<script src="{%static 'assets/js/demo/render.highlight.js' %}"></script>
<!--  -->
<script src="{%static 'assets/plugins/DataTables/media/js/jquery.dataTables.js' %}"></script>
<script src="{%static 'assets/plugins/DataTables/media/js/dataTables.bootstrap.min.js' %}"></script>
<script src="{%static 'assets/plugins/DataTables/extensions/Responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{%static 'assets/js/demo/table-manage-responsive.demo.min.js' %}"></script>
<!--  -->
<script src="{%static 'assets/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js' %}"></script>
<script src="{%static 'assets/plugins/ionRangeSlider/js/ion-rangeSlider/ion.rangeSlider.min.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js' %}"></script>
<script src="{%static 'assets/plugins/password-indicator/js/password-indicator.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-combobox/js/bootstrap-combobox.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-select/bootstrap-select.min.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput.min.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput-typeahead.js' %}"></script>
<script src="{%static 'assets/plugins/jquery-tag-it/js/tag-it.min.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-daterangepicker/moment.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-daterangepicker/daterangepicker.js' %}"></script>
<script src="{%static 'assets/plugins/select2/dist/js/select2.min.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-eonasdan-datetimepicker/build/js/bootstrap-datetimepicker.min.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-show-password/bootstrap-show-password.js' %}"></script>
<script src="{%static 'assets/plugins/bootstrap-colorpalette/js/bootstrap-colorpalette.js' %}"></script>
<script src="{%static 'assets/plugins/jquery-simplecolorpicker/jquery.simplecolorpicker.js' %}"></script>
<script src="{%static 'assets/plugins/clipboard/clipboard.min.js' %}"></script>
<script src="{%static 'assets/js/demo/form-plugins.demo.min.js' %}"></script>
{% endblock %}
{% block init %}
<script>
    $(document).ready(function() {
        App.init();
        Highlight.init();
        highlightSideNav();
        TableManageResponsive.init();
        $('select').selectpicker('render');
        getCurrentORnum();
        getIncType();
        loadEducLevels();
    });

    $('#or_fname').on('focusin', function() {
        if ($('#radiorequired3').prop('checked')) {
            $('#or_fname').blur();
        }
        else {
            $('#or_fname').off('blur');
        }
    });

    function getIncType() {
        $.ajax({
            type: "POST",
            url: "{% url 'get_income_type' %}",
            // cache: true,
            dataType: 'json',
            data: {
                csrfmiddlewaretoken:"{{csrf_token}}"
            },
            success: function(obj) {
                $.each(obj, function(index, option){
                    $('#inc-select').append( new Option(option,option)); //value and text
                });
                $('#inc-select option').prop('style', 'font-size: 11px;')
                $('#inc-select').selectpicker('refresh');
            },
            error: function(xhr, status, error) {
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: errMsg,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        });
    };
    function getUacsCode(incomeType) {
        $.ajax({
            type: "POST",
            url: "{% url 'get_uacs_code' %}",
            cache: false,
            dataType: 'json',
            data: {
                incomeType: incomeType,
                csrfmiddlewaretoken:"{{csrf_token}}"
            },
            success: function(obj) {
                $('#uacs_select').empty();
                $('#uacs_select').append(new Option('Please choose')).select();
                $('#uacs_select').find('option:selected').prop('disabled',true);                
                $.each(obj, function(index, option){
                    $('#uacs_select').append( new Option(option[1],option[0])); //text and value
                });
                $('#uacs_select option').prop('style', 'font-size: 11px;');
                $('#uacs_select').selectpicker('refresh');
            },
            error: function(xhr, status, error) {
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: errMsg,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        });
    };
    function getCurrentORnum() {
        $.ajax({
            type: "POST",
            url: "{% url 'get_current_or' %}",
            cache: true,
            dataType: 'json',
            data: {
                csrfmiddlewaretoken:"{{csrf_token}}"
            },
            success: function(obj) {
                $('#or_num').val(obj[0].toString());
            },
            error: function(xhr, status, error) {
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: errMsg,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        });
    };
    
    var getCurrentUserID;
    function callback(response) {
        getCurrentUserID = response;
    }
    $.ajax({
        url: "{% url 'get_session' %}",
        type: "POST",
        data: {
            csrfmiddlewaretoken:"{{csrf_token}}"
        },
        success: function(role_session) {
            callback(role_session)
        }
    });

    function loadEducLevels() {
        $.ajax({
            type: "POST",
            url: "{% url 'load_educ_level' %}",
            cache: false,
            dataType: 'json',
            data: {
                csrfmiddlewaretoken:"{{csrf_token}}"
            },
            success: function(obj) {
                $.each(obj, function(index, option){
                    $('#educ-levels').append( new Option(option[0],option[0])); //value and text
                });
                $('#educ-levels option').prop('style', 'font-size: 11px;')
                $('#educ-levels').selectpicker('refresh');
            },
            error: function(xhr, status, error) {
                swal({
                    title: "Error!", 
                    text: error,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                });
            }
        });
    };

    function saveCollection(or_num) {
        var assessed = parseFloat($('#r_grandtotal').text().substring(1).replace(/,/g,''));
        var collected = parseFloat($('#r_grandtotal').text().substring(1).replace(/,/g,''));
        var studno = $('#r_studnum').text();
        var client = $('#r_name').text(); 
        var educ_level = $('#radiorequired2').prop('checked')  ? '' : $('#radiorequired').prop('checked') ? 'NON-STUDENT' : $('#educ-levels').selectpicker('val');
        var userID = getCurrentUserID;
        var is_direct = $('#direct_deposit_checkbox').prop('checked') ? 1 : 0;
        $.ajax({
            type: "POST",
            url: "{% url 'insert_collection' %}",
            cache: true,
            dataType: 'json',
            data: {
                or_num: or_num,
                assessed: assessed,
                collected: collected,
                studno: studno,
                client: client,
                educ_level: educ_level,
                userID: userID,
                is_direct: is_direct,
                csrfmiddlewaretoken:"{{csrf_token}}"
            },
            timeout: 2000,
            success: function(obj) {
                console.log(obj);
            },
            error: function(xhr, status, error) {
                $('save-icon').removeClass('fa-spinner fa-pulse');
                $('save-icon').addClass('fa-save');
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: error,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        });
    };

    function saveCollectionBreakdown(or_num) {
        var dt_res = $('#data-table-responsives tbody');
        var dt_res_len = $('#data-table-responsives tbody tr').length;
        for (var i = 0; i < dt_res_len; i++) {
            var desc = dt_res.find('tr:eq('+ i +')').find('td:eq(1)').text();
            var nature = dt_res.find('tr:eq('+ i +')').find('td:eq(2)').text();
            var amt = dt_res.find('tr:eq('+ i +')').find('td:eq(4)').text();
            $.ajax({
                type: "POST",
                url: "{% url 'insert_collection_breakdown' %}",
                cache: false,
                dataType: 'json',
                data: {
                    or_num: or_num,
                    desc: desc.trim(),
                    nature: nature.trim(),
                    amt: amt,
                    csrfmiddlewaretoken:"{{csrf_token}}"
                },
                success: function(obj) {
                    // console.log(obj);
                },
                error: function(xhr, status, error) {
                    $('save-icon').removeClass('fa-spinner fa-pulse');
                    $('save-icon').addClass('fa-save');
                    var errMsg = xhr.status + ': ' + xhr.statusText;
                    swal({
                        title: "Error!", 
                        text: error,
                        type: "error",
                        confirmButtonColor: "#428bca",
                        showLoaderOnConfirm: true
                    })
                }
            });
        }
        return;
    };

    $('#inc-select').on('change', function() {
        getUacsCode($('#inc-select').val());
    });

    $('#or_studnum').on('focusin', function() {
        $('#or_studnum').mask('9999-99999-CM-9'); //masked input for student number
    });

    $('#or_studnum').on('focusout', function() {
        if ($('#or_studnum').val()[0] == '_') {
            $('#or_studnum').removeClass('nameBox');
        }
    });

    $('#or_lname').on('keyup', function(e) {
        if ($('#or_lname').val() != '' && $('#radiorequired3').prop('checked')) { //if lname textbox != empty string && student radio button is selected
            var str = $('#or_lname').val().trim();
            handleJqueryAutocomplete(str);
        }
        else if ($('#or_lname').val() == '' && $('#radiorequired3').prop('checked')) {//if lname textbox is empty string && student radio button is selected
            disableButtons();
        }
        else if ($('#radiorequired').prop('checked') || $('#radiorequired2').prop('checked')) {
            enableButtons();
        }
    });

    function enableButtons() {
        $('#particular').prop('disabled', false);
        $('#save').prop('disabled', false);
    };

    function disableButtons() {
        $('#particular').prop('disabled', true);
        $('#save').prop('disabled', true);
        if ($('#radiorequired3').prop('checked')) {
            $('#or_studnum').prop('style', 'text-transform: capitalize;'); 
        }
    };

    $('#or_studnum').on('keyup', function(e) {
        var studno = $('#or_studnum').val().trim();
        var ch = String.fromCharCode(e.which);
        if (e.keyCode == 8) {
            if (studno[0] == '_') {
                $('#or_studnum').removeClass('nameBox');
                $('#or_studnum').prop('style', 'text-transform: capitalize;'); 
            }
        }
        if (!(/[0-9]/.test(ch))) {
            e.preventDefault();
        }
        else {
            $('#or_studnum').addClass('nameBox');
            if (studno.length > 11) {
                $('#or_studnum').prop('style', 'text-transform: uppercase;'); 
            }
            else {
                $('#or_studnum').prop('style', 'text-transform: capitalize;'); 
            }
        }
        getStudName(studno);
    });

    $('#or_studnum').on('focusin', function() {
        $('#or_studnum').addClass('nameBox');
    });

    function getStudName(studno) {
        $.ajax({
            type: "POST",
            url: "{% url 'get_student_name' %}",
            cache: true,
            dataType: 'json',
            data: {
                studno: studno,
                csrfmiddlewaretoken:"{{csrf_token}}"
            },
            success: function(obj) {
                if (obj[0] != null) {
                    $('#or_lname').val(obj[0][1].toString());
                    $('#or_fname').val(obj[0][0].toString());
                    $('#educ-levels').selectpicker('val', $('#no-studnum-checkbox').prop('checked') ? 'Select level of education' : obj[0][2].toString());
                    $('#addForm').parsley().reset();
                    enableButtons();
                }
                else {
                    $('#or_lname').val('');
                    $('#or_fname').val('');
                    disableButtons();
                }
            },
            error: function(xhr, status, error) {
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: errMsg,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        }); 
    }

    $("#save").on('click', function() { //save entry is clicked
        
        if ($('#no-studnum-checkbox').prop('checked')) {
            $('#or_studnum').prop('required', false);
        }
        else {
            $('#or_studnum').prop('required', true);
        }
        $('#addForm').parsley();
        if ($('#addForm').parsley().validate()) {
            $('#save-icon').removeClass('fa-save');
            $('#save-icon').addClass('fa-spinner fa-pulse');
            if ($('#radiorequired3').prop('checked')) { // student is checked
                if ($('.individual_sel').find('option:selected').text() =='Select level of education') { // missing level of education
                    swal({
                        title: "Missing Data", 
                        text: "Please select level of education.",
                        type: "info",
                        confirmButtonColor: "#428bca",
                        showLoaderOnConfirm: true
                    },function(isConfirm) {
                        $('#save-icon').removeClass('fa-spinner fa-pulse');
                        $('#save-icon').addClass('fa-save');
                    });
                }
                else {
                    no_err_when_save_collection();
                }
            }
            else { // not student
                no_err_when_save_collection();
            }
        }
    });

    var quty = 1;

    function no_err_when_save_collection() {
        var ornum = $('#or_num').val();
        if ($('#data-table-responsives tbody tr').length > 0) {
            $('#receipt').modal('show');
            var dt_res = $('#data-table-responsives tbody');
            var dt_res_len = $('#data-table-responsives tbody tr').length;
            for (i = 0; i < dt_res_len; i++) {
                $('.table-invoice tbody').append(
                    `<tr>
                        <td>
                            <span class="text-inverse" id="r_desc">${quty + ' ' +dt_res.find('tr:eq('+ i +')').find('td:eq(1)').text() + (dt_res.find('tr:eq('+ i +')').find('td:eq(2)').text() != '' ? ' ('+dt_res.find('tr:eq('+ i +')').find('td:eq(2)').text()+')' : '')}</span><br />
                        </td>
                        <td class="text-center" id="r_amount">${dt_res.find('tr:eq('+ i +')').find('td:eq(4)').text()}</td>
                    </tr>`
                );
            }

            $('#r_ornum').text(ornum);

            if ($('#radiorequired3').prop('checked')) { //student is selected
                var fullname = $('#or_lname').val()+', '+$('#or_fname').val();
                $('#r_name').text(fullname.toUpperCase());
                $('#r_studnum').text($('#or_studnum').val().toUpperCase());
            }
            else if ($('#radiorequired2').prop('checked')) { //company is selected
                $('#r_name').text($('#or_comp').val().toUpperCase());
                $('#r_studnum').text('');
            }
            else if ($('#radiorequired').prop('checked')) { //non-student is selected
                var fullname = $('#or_lname').val()+', '+$('#or_fname').val();
                $('#r_name').text(fullname.toUpperCase());
                $('#r_studnum').text('');
            }

            $('#r_date').text($('#or_date').val());
            var dt = new Date();
            var hrs = dt.getHours();
            var mins = dt.getMinutes();
            var ampm = (hrs >= 12) ? "PM" : "AM";
            var time = (hrs % 12 || 12) + ":" + ((mins<10?'0':'') + mins) + ' ' + ampm;
            $('#r_time').text(time);
            $('#r_grandtotal_words').text(parseFloat($('#total-fee').text()));
            $('#r_grandtotal').text('₱'+$('#total-fee').text().toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")).delay(1000).queue(function() {
                saveCollection(ornum);
                setTimeout(function() {
                    saveCollectionBreakdown(ornum);
                }, 1000);
                $(this).dequeue();
            });
        }
        else {
            $('#save-icon').removeClass('fa-spinner fa-pulse');
            $('#save-icon').addClass('fa-save');
            swal({
                title: "No Payment Added", 
                text: "Please add particulars to generate a receipt.",
                type: "warning",
                confirmButtonColor: "#428bca",
                showLoaderOnConfirm: true
            });
        }
    };

    $('#receipt').on('hidden.bs.modal', function (e) { //when receipt modal is closed
        $('.table-invoice tbody tr').remove();
        $('or_num').val(getCurrentORnum());
        $('#or_lname').val('');
        $('#or_fname').val('');
        $('#or_studnum').prop('style', 'text-transform: capitalize');
        $('#or_studnum').val('').removeClass('nameBox');
        if ($('#radiorequired').prop('checked') || $('#radiorequired2').prop('checked')) {
            $('.studno').hide();
        }
        $('.individual_sel').val('Select level of education');
        $('.individual_sel').selectpicker('refresh');
        $('#or_comp').val('');
        $('#total-fee').text(parseFloat('0').toFixed(2));
        $('#inc-select').val('Please choose');
        $('#uacs_select').val('Please choose');
        $('#number').val('');
        $('#data-table-responsives tbody tr').remove();
        $('#save-icon').removeClass('fa-spinner fa-pulse');
        $('#save-icon').addClass('fa-save');
        $('#addForm').parsley().reset();
    });

    $("#radiorequired").click(function() { //non-student radio
        $('.company').hide();
        $('.studno').hide();
        $('.individual').show();
        $('.individual_sel').selectpicker('hide');
        $('#or_lname').val('');
        $('#or_fname').val('');
        $('#or_comp').val('');
        $('#or_studnum').val('');
        $('#addForm').parsley().reset();
        $('#no-studnum-div').hide();
        enableButtons();
    });
    $("#radiorequired2").click(function() { //company radio
        $('.individual').hide();
        $('.individual_sel').selectpicker('hide');
        $('.studno').hide();
        $('.company').show();
        $('#or_lname').val('');
        $('#or_fname').val('');
        $('#or_studnum').val('');
        $('#addForm').parsley().reset();
        $('#no-studnum-div').hide();
        enableButtons();
    });
    $("#radiorequired3").click(function() { //student radio
        $('.individual_sel').selectpicker('show');
        $('.individual').show();
        $('.company').hide();
        $('#or_lname').val('');
        $('#or_fname').val('');
        $('#or_studnum').removeClass('nameBox');
        $('.studno').show();
        $('#or_comp').val('');
        $('#addForm').parsley().reset();
        $('#or_studnum').prop('style', 'text-transform: capitalize;');
        $('#no-studnum-div').show();
        disableButtons();
    });
    var total_fee = 0;
    var minus_fee = '';
    $('#particular').on('click', function() {
        var tot_fee_txt = $('#total-fee').text();
        var init_tot_fee = parseFloat(tot_fee_txt);
        var inctype = $('#inc-select').find('option:selected').text();
        var uacs = $('#uacs_select').find('option:selected').text();
        var nature = $('#nature-select').find('option:selected').text() == 'Please choose' ? '' : $('#nature-select').find('option:selected').text();
        var amt = parseFloat($('#number').val());
        var qty = $('#qty').val();
        var amtBox = $('#number').val().trim();
        if (inctype == 'Please choose' || uacs == 'Please choose') {
            if (inctype == 'Please choose') {
                swal({
                    title: "Missing Data", 
                    text: "Please select Income Type.",
                    type: "info",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                });
            }
            else if (uacs == 'Please choose') {
                swal({
                    title: "Missing Data", 
                    text: "Please select UA Code.",
                    type: "info",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                });
            }
            if (amtBox == '' && amtBox.length == 0) {
                $('#number').addClass('is-invalid');
            }
        }
        else {
            $('#inc-select').removeClass('is-invalid');
            $('#uacs_select').removeClass('is-invalid');
            if (amtBox != '' && amtBox.length != 0) {
                quty = $('#qty').val();
                $('#number').removeClass('is-invalid');
                $('#data-table-responsives tbody').append(
                    `<tr>
                        <td class="text-nowrap">
                            <span class="label label-default f-s-12">${inctype}</span>
                        </td>
                        <td class="f-s-12">${uacs}</td>
                        <td class="f-s-12">${nature}</td>
                        <td class="f-s-12">${qty}</td>
                        <td>${amt.toFixed(2)}</td>
                        <td align="center">
                            <a href="javascript:;" class="btn btn-danger btn-icon btn-circle btn-sm remove" title="remove"><i class="fas fa-times"></i></a>
                        </td>
                    </tr>`
                );
                total_fee = init_tot_fee + parseFloat(amt);
                $('#total-fee').text(parseFloat(total_fee).toFixed(2));
                $('#inc-select').selectpicker('val','Please choose');
                $('#uacs_select').selectpicker('val','Please choose');
                $('#nature-select').selectpicker('val','Please choose');
                $('#number').val('').prop('readonly', false);
            }
            else {
                $('#number').addClass('is-invalid');
            }
        }
    });
    $('#inc-select').on('change', function() {
        if ($('#inc-select').val() == 'Please choose') {
            $('#inc-select').selectpicker().addClass('is-invalid');
        }
        else {
            $('#inc-select').selectpicker().removeClass('is-invalid');
            $('#nature-div').hide();
            $('#number').val('').prop('readonly', false);
        }
    });
    $('#uacs_select').on('change', function() {
        if ($('#uacs_select').val() == 'Please choose') {
            $('#uacs_select').addClass('is-invalid');
            $('#nature-div').hide();
            $('#number').val('').prop('readonly', false);
        }
        else {
            $('#uacs_select').removeClass('is-invalid');
            $('#nature-div').hide();
            $('#number').val('').prop('readonly', false);
            var uacs = $('#uacs_select').val();
            $.ajax({
                type: "POST",
                url: "{% url 'load_nature_col' %}",
                cache: true,
                dataType: 'json',
                data: {
                    uacs: uacs,
                    csrfmiddlewaretoken:"{{csrf_token}}"
                },
                success: function(obj) {
                    if (obj.length != 0) {
                        $('#nature-div').show(); 
                        $('#nature-select').empty();
                        $('#nature-select').append(new Option('Please choose')).select();
                        $('#nature-select').find('option:selected').prop('disabled',true);                
                        $.each(obj, function(index, option){
                            $('#nature-select').append( new Option(option[0],option[0])); //text and value
                        });
                        $('#nature-select option').prop('style', 'font-size: 11px;');
                        $('#nature-select').selectpicker('refresh');                       
                    }
                    else {
                        $('#nature-div').hide();
                        checkPrice($('#uacs_select').selectpicker('val'));
                    }
                    $('#qty').val('1');
                },
                error: function(xhr, status, error) {
                    var errMsg = xhr.status + ': ' + xhr.statusText;
                    swal({
                        title: "Error!", 
                        text: errMsg,
                        type: "error",
                        confirmButtonColor: "#428bca",
                        showLoaderOnConfirm: true
                    })
                }
            }); 
        }
    });

    $('#nature-select').on('change', function() {
        checkPriceNature($('#nature-select').selectpicker('val'));
    });

    function checkPrice(uacs) {
        $.ajax({
            type: 'POST',
            url: '{% url "check_price" %}',
            cache: true,
            dataType: 'json',
            data: {
                uacs: uacs,
                csrfmiddlewaretoken: '{{csrf_token}}'
            },
            success: function(obj) {
                if (obj[0][0] != null) {
                    var price = parseFloat(obj);
                    var qty = parseFloat($('#qty').val());
                    var amt = price * qty;
                    $('#number').val(amt.toFixed(2)).prop('readonly', true);
                }
                else {
                    $('#number').val('').prop('readonly', false);
                }
            },
            error: function(xhr, status, error) {
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: errMsg,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        });
    };

    function checkPriceNature(name) {
        $.ajax({
            type: 'POST',
            url: '{% url "check_price_nature" %}',
            cache: true,
            dataType: 'json',
            data: {
                name: name,
                csrfmiddlewaretoken: '{{csrf_token}}'
            },
            success: function(obj) {
                if (obj[0][0] != null) {
                    var price = parseFloat(obj);
                    var qty = parseFloat($('#qty').val());
                    var amt = price * qty;
                    $('#number').val(amt.toFixed(2)).prop('readonly', true);
                }
                else {
                    $('#number').val('').prop('readonly', false);
                }
            },
            error: function(xhr, status, error) {
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: errMsg,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        });
    };

    $('#number').on('input', function() {
        if ($('#number').val().trim().length == 0) {
            $('#number').addClass('is-invalid');
        }
        else {
            $('#number').removeClass('is-invalid');
        }
    });

    $('.individual_sel').on('change', function() {
        if ($('.individual_sel').val()!='Select level of education') {
            $('.individual_sel').removeClass('is-invalid');
        }
    });

    $('#data-table-responsives tbody').on('click', '.remove', function() {
        minus_fee = $(this).closest('tr').find('td:eq(4)').html();
        total_fee = total_fee - parseFloat(minus_fee);
        $('#total-fee').text(total_fee.toFixed(2));
        $(this).closest('tr').remove();
    });

    function handleJqueryAutocomplete(str) {
        var availableTags = [];
        var _url = $('#no-studnum-checkbox').prop('checked') ? '/search_last_name_nostudno' : '/search_last_name';
        var comma_or_none = _url.length == 17 ? ', ' : '';
        $('#or_fname').val('');
        $('#or_studnum').val('').removeClass('nameBox');
        $('#or_studnum').prop('style', 'text-transform: capitalize;');
        $.ajax({
            type: "POST",
            url: _url,
            cache: false,
            dataType: 'json',
            data: {
                str: str,
                csrfmiddlewaretoken:"{{csrf_token}}"
            },
            success: function(obj) {
                if (obj.length != 0) {
                    for (var i = j = 0; i < obj.length; i++) {
                        availableTags[i] = obj[i][j] + ', ' + obj[i][j+1] + comma_or_none + obj[i][j+2] + ', ' + obj[i][j+3];  
                    }
                    $('#or_lname').autocomplete({
                        source: availableTags,
                        select : showResult,
                        focus : showResult,
                        change : showResult,
                        keydown : showResult,
                    });
                    function showResult(event, ui) {
                        event.preventDefault();
                        $('#or_lname').val($.trim(ui.item.label.split(',')[0]));
                        $('#or_fname').val($.trim(ui.item.label.split(',')[1]));
                        if (_url.length == 17) {
                            $('#or_studnum').val($.trim(ui.item.label.split(',')[2])).trigger('focusin');
                        }
                        $('#educ-levels').selectpicker('val', $('#no-studnum-checkbox').prop('checked') ? $.trim(ui.item.label.split(',')[2]) : $.trim(ui.item.label.split(',')[3]) );
                        if (event.which == 13) {
                            setTimeout(function() {
                                $('#or_fname').click();
                                $('#or_lname').blur();
                            }, 300); // I don't know how this works, but setting timeout really helps in displaying the data to its alloted                             
                                     //textbox when you press enter rather than mousehover/mouseclick;
                        }
                        enableButtons();
                    };
                }
                disableButtons();
            },
            error: function(xhr, status, error) {
                var errMsg = xhr.status + ': ' + xhr.statusText;
                swal({
                    title: "Error!", 
                    text: errMsg,
                    type: "error",
                    confirmButtonColor: "#428bca",
                    showLoaderOnConfirm: true
                })
            }
        });
    };

    $('#no-studnum-checkbox').on('click', function() {
        $('#or_studnum').val('');
        $('#or_studnum').removeClass('nameBox');
        $('#or_lname').val('').empty();
        $('#or_fname').val('');
        disableButtons();
        if ($('#no-studnum-checkbox').prop('checked')) {
            $('#or_studnum').prop('disabled', true);
        }
        else {
            $('#or_studnum').prop('disabled', false);
        }
    });

    $('#qty-plus').on('click', function() {
        if ($('#number').val().trim().length != 0) {
            var qty = $('#qty').val();
            $('#qty').val(parseInt(qty)+1);
            var amt = parseFloat($('#number').val())/qty;
            qty++;
            $('#number').val((amt * qty).toFixed(2));
        }
    });

    $('#qty-minus').on('click', function() {
        if ($('#number').val().trim().length != 0) {
            var qty = $('#qty').val();
            if (parseInt(qty) != 1) {
                $('#qty').val(parseInt(qty)-1); 
                var amt = parseFloat($('#number').val())/qty;
                qty--;
                $('#number').val((amt * qty).toFixed(2));
            }
        }
    });

    function highlightSideNav() {
        $('#li-dash').removeClass('text-white');
        $('#add-col-caret').click();
        $('#add-col-caret').addClass('text-white');
        $('#add-col').addClass('text-white');
        $('#add-sis').removeClass('text-white');
        $('#view-rec-caret').removeClass('text-white');
        $('#view-rec').removeClass('text-white');
        $('#trans-log').removeClass('text-white');
        $('#view-sis').removeClass('text-white');
        $('#col-rep-caret').removeClass('text-white');
        $('#acct-forms').removeClass('text-white');
        $('#cert').removeClass('text-white');
        $('#mon-col').removeClass('text-white');
        $('#sum-col').removeClass('text-white');
        $('#cash-receipt').removeClass('text-white');
        $('#pending_but').removeClass('text-white');
        $('#deposited_but').removeClass('text-white');
    };
</script>
{% endblock %}